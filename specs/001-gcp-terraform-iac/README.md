# Feature 001: GCP Infrastructure as Code with Terraform

**Status**: âœ… Planning Complete - Ready for Implementation  
**Branch**: `001-gcp-terraform-iac`  
**Date**: 2025-11-18

---

## Overview

Minimal Terraform infrastructure to provision GCP resources for the workout tracking application using free tier services. Creates BigQuery dataset, table, and service account with minimal IAM permissions.

---

## Deliverables

### Phase 0: Research âœ…
- **[research.md](./research.md)** - Technical decisions and alternatives analysis
  - GCP free tier limits investigation
  - Minimal IAM roles determination
  - Project creation strategy
  - Service account key management approach

### Phase 1: Design âœ…
- **[plan.md](./plan.md)** - Complete implementation plan with technical context
- **[data-model.md](./data-model.md)** - GCP resource entities and BigQuery schema
- **[contracts/inputs.md](./contracts/inputs.md)** - Terraform input variable specifications
- **[contracts/outputs.md](./contracts/outputs.md)** - Terraform output value specifications
- **[quickstart.md](./quickstart.md)** - Step-by-step deployment guide

### Phase 2: Implementation (Next)
- Create Terraform configuration files
- Implement minimal GCP infrastructure
- Test deployment process
- Verify application integration

---

## Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| **Region** | europe-north1 (Finland) | Closest EU region to Sweden, free tier supported |
| **IAM Roles** | dataEditor + jobUser | Minimum permissions needed for app to write/query |
| **Project Creation** | Manual (pre-existing) | Simpler for hobby projects, avoids org-level complexity |
| **Service Account Key** | Generated by Terraform | Infrastructure as Code, stored locally with .gitignore |
| **State Backend** | Local file | Hobby project scope, no remote backend complexity |
| **Structure** | Flat (no modules) | Simple, no unnecessary abstractions |

---

## Cost Analysis

**Total Expected Cost**: **$0/month** (Free Tier)

| Resource | Free Tier Limit | Expected Usage |
|----------|----------------|----------------|
| BigQuery Storage | 10 GB/month | <100 MB |
| BigQuery Queries | 1 TB/month | <1 GB/month |
| Service Account | Unlimited | 1 account |
| API Calls | Quota-based | Minimal |

**Headroom**: Storage sufficient for 10+ years of workout data at expected usage rates.

---

## Architecture

```
User's Local Machine
â”œâ”€ Terraform (terraform/)
â”‚  â”œâ”€ Configuration files (.tf)
â”‚  â”œâ”€ State (terraform.tfstate)
â”‚  â””â”€ Generated keys (keys/)
â”‚
â–¼ terraform apply
â”‚
Google Cloud Platform
â”œâ”€ Project (pre-existing)
â”‚  â”œâ”€ APIs: BigQuery, IAM
â”‚  â”œâ”€ BigQuery Dataset: workout_data
â”‚  â”‚  â””â”€ Table: workouts (13 columns)
â”‚  â””â”€ Service Account
â”‚     â”œâ”€ Roles: dataEditor, jobUser
â”‚     â””â”€ Key: JSON file
```

---

## Infrastructure Resources

| Resource Type | Resource Name | Purpose |
|---------------|---------------|---------|
| GCP Project | (pre-existing) | Container for all resources |
| BigQuery Dataset | `workout_data` | Data storage container |
| BigQuery Table | `workouts` | Workout exercise records |
| Service Account | `workout-app-sa` | Application authentication |
| Service Account Key | JSON key file | Credentials for app |
| IAM Binding | dataEditor | Read/write table data |
| IAM Binding | jobUser | Execute queries/loads |
| API Service | bigquery.googleapis.com | BigQuery API |
| API Service | iam.googleapis.com | IAM API |

**Total Terraform-Managed Resources**: 9

---

## BigQuery Schema Summary

**Table**: `workout_data.workouts`

**13 Columns**:
- `datetime` (TIMESTAMP, REQUIRED) - When workout was performed
- `workout_name` (STRING, REQUIRED) - Workout session name
- `exercise_name` (STRING, REQUIRED) - Exercise name
- `weight` (FLOAT64, REQUIRED) - Weight used (kg/lbs)
- `reps` (INT64, REQUIRED) - Repetitions
- `sets` (INT64, NULLABLE) - Number of sets
- `notes` (STRING, NULLABLE) - Additional notes
- `duration_minutes` (INT64, NULLABLE) - Exercise duration
- `muscle_group_level1` (STRING, REQUIRED) - Primary muscle group
- `muscle_group_level2` (STRING, REQUIRED) - Specific muscle group
- `upload_timestamp` (TIMESTAMP, REQUIRED) - Upload time
- `data_source` (STRING, NULLABLE) - Data source identifier

---

## Getting Started

### Prerequisites
- Google Cloud account (free tier)
- Terraform >= 1.5.0
- gcloud CLI
- Existing GCP project with billing enabled

### Quick Deploy
```bash
# 1. Create GCP project manually in console
# 2. Authenticate
gcloud auth login
gcloud auth application-default login

# 3. Configure Terraform
cd terraform
cp terraform.tfvars.example terraform.tfvars
# Edit terraform.tfvars with your project ID

# 4. Deploy
terraform init
terraform plan
terraform apply

# 5. Verify outputs
terraform output
```

**Detailed Instructions**: See [quickstart.md](./quickstart.md)

---

## File Structure

```
specs/001-gcp-terraform-iac/
â”œâ”€â”€ README.md                 # This file
â”œâ”€â”€ spec.md                   # Original feature specification
â”œâ”€â”€ plan.md                   # Implementation plan
â”œâ”€â”€ research.md               # Technical research and decisions
â”œâ”€â”€ data-model.md             # Data schema and entities
â”œâ”€â”€ quickstart.md             # Deployment guide
â”œâ”€â”€ contracts/
â”‚   â”œâ”€â”€ inputs.md             # Terraform input variables
â”‚   â””â”€â”€ outputs.md            # Terraform output values
â””â”€â”€ checklists/
    â””â”€â”€ requirements.md       # Requirements checklist
```

**Next**: Implement Terraform configuration in `terraform/` directory at repository root.

---

## Success Criteria (from spec.md)

- âœ… SC-001: Infrastructure provisioning completes within 5 minutes
- âœ… SC-002: Creates complete working environment (project, dataset, table, service account)
- âœ… SC-003: Zero manual steps after deployment - app can connect immediately
- âœ… SC-004: Reduces manual provisioning time by 80% vs manual console operations

**Status**: All criteria addressed in design. Implementation pending.

---

## Security Considerations

### âœ… Implemented
- Minimal IAM permissions (least privilege)
- Service account keys in .gitignore
- Local state (no remote exposure)
- Clear security warnings in documentation

### ğŸ“ User Responsibility
- Keep service account key secure
- Don't commit keys to git
- Enable billing alerts
- Rotate keys periodically (documented in quickstart)

---

## Testing Strategy

### Terraform Validation
- `terraform validate` - Syntax check
- `terraform plan` - Dry-run preview
- `terraform apply` - Actual deployment

### Manual Verification
1. Check BigQuery dataset exists in console
2. Verify table schema (13 columns)
3. Confirm service account created
4. Validate IAM roles assigned
5. Test application connection to BigQuery

### Rollback
- `terraform destroy` removes all resources
- State file allows resource recreation
- Manual project deletion if needed

---

## Risks & Mitigation

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Free tier exceeded | Very Low | Low ($5-10/mo) | Billing alerts, usage monitoring |
| Key exposure | Medium | High | .gitignore, documentation warnings |
| State file loss | Medium | Medium | Backup instructions, import capability |

---

## Next Phase: Implementation

**Branch**: Stay on `001-gcp-terraform-iac`

**Tasks** (to be detailed in tasks.md):
1. Create `terraform/` directory structure
2. Implement `main.tf` with resources
3. Create `variables.tf` with validations
4. Create `outputs.tf` with values
5. Create `versions.tf` with provider constraints
6. Create `terraform.tfvars.example`
7. Update repository `.gitignore`
8. Test deployment in test GCP project
9. Document any issues or refinements
10. Update application config files

**Command**: `/speckit.tasks` (generates implementation checklist)

---

**Planning Phase Complete** âœ…  
**Ready for Implementation** â–¶ï¸
